name: Build GKI

on:
  workflow_call:
    inputs:
      TODO:
        type: string
      KSU:
        type: string
      KSU_SUSFS:
        type: string
      KSU_MANUAL_HOOK:
        type: string
      LAST_BUILD:
        type: string

  workflow_dispatch:
    inputs:
      TODO:
        description: To do
        default: ""
        type: choice
        options:
          - kernel
          - defconfig

      KSU:
        description: KernelSU variant
        default: None
        type: choice
        options:
          - None
          - Next
          - Suki
          - Magic

      KSU_SUSFS:
        description: Include SUSFS?
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

      KSU_MANUAL_HOOK:
        description: Use KSU Manual Hooks?
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

env:
  MAN_DISABLE: true
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Print disk space before cleanup
        shell: bash
        run: |
          df -h

      - name: Free Disk Space (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          os_id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')
          echo "Detected OS: $os_id"

          if command -v docker >/dev/null 2>&1; then
            docker images -aq | xargs -r sudo docker rmi -f || true
          fi

          sudo rm -rf \
            /usr/local/lib/android \
            /usr/share/dotnet \
            /opt/ghc \
            /usr/local/.ghcup \
            /usr/local/share/powershell \
            /usr/share/swift \
            /usr/lib/jvm || true

          if [[ "$os_id" == "ubuntu" ]]; then
            sudo apt-get remove -y '^mysql-.*' '^dotnet-.*' 'php.*' '^mongodb-.*' '^llvm-.*' \
              google-cloud-sdk google-cloud-cli || true
            sudo apt-get autoremove -y
            sudo apt-get autoclean -y
          fi

      - name: Print disk space after cleanup
        shell: bash
        run: |
          df -h

      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine Build Status
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            echo "STATUS=RELEASE" >> $GITHUB_ENV
            echo "TRIGGER=workflow_call" >> $GITHUB_ENV
          else
            echo "STATUS=BETA" >> $GITHUB_ENV
            echo "TRIGGER=workflow_dispatch" >> $GITHUB_ENV
          fi

      - name: Validate Inputs and Secrets
        shell: bash
        env:
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          KSU: ${{ inputs.KSU }}
          KSU_SUSFS: ${{ inputs.KSU_SUSFS }}
          KSU_MANUAL_HOOK: ${{ inputs.KSU_MANUAL_HOOK }}

      - name: Install Dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gh bc bison flex libssl-dev libelf-dev dwarves cpio

      - name: Enable Swap
        shell: bash
        run: |
          sudo swapoff -a || true
          sudo fallocate -l 5G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile --priority 100
          sudo sysctl vm.swappiness=200
          free -h
          swapon --show

      - name: Run Build Script
        shell: bash
        env:
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          KSU: ${{ inputs.KSU }}
          KSU_SUSFS: ${{ inputs.KSU_SUSFS }}
          KSU_MANUAL_HOOK: ${{ inputs.KSU_MANUAL_HOOK }}
          LAST_BUILD: ${{ inputs.LAST_BUILD }}
          TODO: ${{ inputs.TODO }}
        run: |
          export GIT_CLONE_PROTECTION_ACTIVE=false
          chmod +x *.sh
          ./build.sh

      - name: Upload Artifacts (ZIP & IMG)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BASE_NAME }}-${{ github.run_number }}
          path: |
            artifacts/*.zip
            artifacts/*.img

      - name: Upload Artifacts (Info)
        uses: actions/upload-artifact@v4
        with:
          name: info-${{ github.run_number }}
          path: artifacts/*.txt
